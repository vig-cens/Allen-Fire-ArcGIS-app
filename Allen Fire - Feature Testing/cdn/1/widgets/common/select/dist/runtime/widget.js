System.register(["jimu-core","jimu-ui","jimu-ui/basic/sql-expression-runtime","jimu-theme","jimu-arcgis"],(function(e,t){var a={},n={},o={},s={},r={};return{setters:[function(e){a.CONSTANTS=e.CONSTANTS,a.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,a.DataSourceComponent=e.DataSourceComponent,a.DataSourceManager=e.DataSourceManager,a.DataSourceSelectionMode=e.DataSourceSelectionMode,a.DataSourceStatus=e.DataSourceStatus,a.DataSourceTypes=e.DataSourceTypes,a.Immutable=e.Immutable,a.MessageManager=e.MessageManager,a.QueryScope=e.QueryScope,a.React=e.React,a.ReactDOM=e.ReactDOM,a.SqlExpressionMode=e.SqlExpressionMode,a.WidgetVersionManager=e.WidgetVersionManager,a.appActions=e.appActions,a.classNames=e.classNames,a.css=e.css,a.dataSourceUtils=e.dataSourceUtils,a.getAppStore=e.getAppStore,a.hooks=e.hooks,a.jsx=e.jsx,a.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,a.moduleLoader=e.moduleLoader,a.observeStore=e.observeStore,a.utils=e.utils,a.uuidv1=e.uuidv1},function(e){n.Alert=e.Alert,n.Button=e.Button,n.Checkbox=e.Checkbox,n.DataActionList=e.DataActionList,n.DataActionListStyle=e.DataActionListStyle,n.Dropdown=e.Dropdown,n.DropdownButton=e.DropdownButton,n.DropdownItem=e.DropdownItem,n.DropdownMenu=e.DropdownMenu,n.Label=e.Label,n.Loading=e.Loading,n.NumericInput=e.NumericInput,n.Popper=e.Popper,n.Progress=e.Progress,n.SVG=e.SVG,n.Select=e.Select,n.Switch=e.Switch,n.WidgetPlaceholder=e.WidgetPlaceholder,n.defaultMessages=e.defaultMessages},function(e){o.SqlExpressionRuntime=e.SqlExpressionRuntime,o.getShownClauseNumberByExpression=e.getShownClauseNumberByExpression},function(e){s.useTheme=e.useTheme},function(e){r.JimuMapViewComponent=e.JimuMapViewComponent,r.LayerTypes=e.LayerTypes,r.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules}],execute:function(){e((()=>{var e={32772:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M19.5 0H6v4.5h1V1h5v5.133l3.638 6.367H11.3v1h8.2zm-2.71 12.5h1.71V7.022l-3.35 2.606zM14.648 8.75 18.5 5.755V1H13v4.867z" clip-rule="evenodd"></path><path fill="#000" fill-rule="evenodd" d="M11.89 10.006 1 4.165v12.318l2.897-3.357 3.401 6.517 3.367-1.95-3.426-6.564zM2 13.793V5.837l7.11 3.813-3.35.808 3.575 6.85-1.633.947-3.6-6.897z" clip-rule="evenodd"></path></svg>'},71690:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M7 14v-1h2v1zM9 12v-1H7v1zM10 13h4v1h-4zM14 11h-4v1h4z"></path><path fill="#000" fill-rule="evenodd" d="M15 6a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1zM6 9V7h9v2zm9 6v-5H6v5zM0 10.5V12a1 1 0 0 0 1 1h1.5v-1H1v-1.5zM2.5 1H1a1 1 0 0 0-1 1v1.5h1V2h1.5zM0 8.5h1v-3H0zM4.5 1v1h3V1zm5 0v1H11v1.5h1V2a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>'},25813:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8.95 3a2.5 2.5 0 0 1-4.9 0H.5a.5.5 0 0 1 0-1h3.55a2.5 2.5 0 0 1 4.9 0h6.55a.5.5 0 0 1 0 1zM6.5 4a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m7.45 4.5a2.5 2.5 0 0 1-4.9 0H.5a.5.5 0 0 1 0-1h8.55a2.5 2.5 0 0 1 4.9 0h1.55a.5.5 0 0 1 0 1zm-2.45 1a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m-7 6.5a2.5 2.5 0 0 0 2.45-2h8.55a.5.5 0 0 0 0-1H6.95a2.5 2.5 0 0 0-4.9 0H.5a.5.5 0 0 0 0 1h1.55a2.5 2.5 0 0 0 2.45 2M3 13.5a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0" clip-rule="evenodd"></path></svg>'},96300:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M15 7.5a.52.52 0 0 1-.516.527H2.976L6.473 11.6a.535.535 0 0 1 0 .746.51.51 0 0 1-.73 0L1 7.5l4.743-4.846a.51.51 0 0 1 .73 0 .535.535 0 0 1 0 .746L2.976 6.973h11.508c.285 0 .516.236.516.527"></path></svg>'},4583:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 17"><path fill="#000" fill-rule="evenodd" d="M0 12v-1.5h1V12h1.5v1H1a1 1 0 0 1-1-1M1 1h1.5v1H1v1.5H0V2a1 1 0 0 1 1-1m0 7.5H0v-3h1zM4.5 2V1h3v1zm5 0V1H11a1 1 0 0 1 1 1v1.5h-1V2zm4.813 14.02-3.535-3.535-3.536 3.535-.707-.707 3.536-3.535-3.536-3.536.707-.707 3.536 3.536 3.535-3.536.707.707-3.535 3.536 3.535 3.535z" clip-rule="evenodd"></path></svg>'},13424:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 17"><path stroke="#000" d="M1 3.5h5M1 9.5h14M1 14.5h14M14 3.5H9l2.5 3z"></path></svg>'},14907:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M16 5.5C16 2.462 13.456 0 10.318 0 7.933 0 5.828 1.435 5 3.56l.886.323.078-.187c.737-1.667 2.438-2.78 4.354-2.78 2.615 0 4.735 2.053 4.735 4.584s-2.12 4.583-4.735 4.583c-.98 0-1.915-.288-2.703-.82l-.54.753.22.142a5.8 5.8 0 0 0 3.023.842C13.456 11 16 8.538 16 5.5M.25 3l8.642 4.969-3.422.738 2.723 5.45-2.886 1.667-2.724-5.45-2.351 2.595zm.996 1.726-.01 5.644 1.527-1.684 2.91 5.771 1.154-.667-2.91-5.77 2.222-.48z" clip-rule="evenodd"></path></svg>'},56509:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="m10.308.302-.589.808 3.84 2.796L9 6.555l5.013 3.736.597-.801-3.796-2.832 4.576-2.657zM.25 3l8.642 4.969-3.423.738 2.724 5.45-2.887 1.667-2.724-5.45-2.35 2.595zm.996 1.726-.01 5.644 1.527-1.684 2.909 5.771 1.155-.667-2.91-5.77 2.222-.48z" clip-rule="evenodd"></path></svg>'},9155:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M14 4a2 2 0 1 1-4 0 2 2 0 0 1 4 0M.25 3l8.642 4.969-3.423.738 2.724 5.45-2.887 1.667-2.724-5.45-2.35 2.595zm.996 1.726-.01 5.644 1.527-1.684 2.909 5.771 1.155-.667-2.91-5.77 2.222-.48z" clip-rule="evenodd"></path></svg>'},31579:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M16 11V0L6 2.982v2.162h.91l-.001-1.49 8.182-2.44v8.882H8.434V11zM.25 3l8.642 4.969-3.422.738 2.723 5.45-2.886 1.667-2.724-5.45-2.351 2.595zm.996 1.726-.01 5.644 1.527-1.684 2.91 5.771 1.154-.667-2.91-5.77 2.222-.48z" clip-rule="evenodd"></path></svg>'},60882:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M16 11V0H5v3.5h1V1h9v9H8.5v1zM.25 3l8.642 4.969-3.422.738 2.723 5.45-2.886 1.667-2.724-5.45-2.351 2.595zm.996 1.726-.01 5.644 1.527-1.684 2.91 5.771 1.154-.667-2.91-5.77 2.222-.48z" clip-rule="evenodd"></path></svg>'},45508:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6.5 7.5A.5.5 0 0 1 7 7h1.5v4.5h1a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0-1h1V8H7a.5.5 0 0 1-.5-.5"></path><path fill="#000" fill-rule="evenodd" d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16m0-1A7 7 0 1 0 8 1a7 7 0 0 0 0 14" clip-rule="evenodd"></path></svg>'},66364:e=>{e.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNOC44OTIxOSA3Ljk2ODU2TDAuMjUwMDg4IDNMMC4yMzE5MzQgMTIuOTY4NkwyLjU4Mjk3IDEwLjM3NEw1LjMwNjcxIDE1LjgyMzdMOC4xOTM0NiAxNC4xNTdMNS40Njk3MiA4LjcwNzM0TDguODkyMTkgNy45Njg1NlpNMS4yMzYzMyAxMC4zNzAxTDEuMjQ2MzMgNC43MjYwN0w2LjEzOTMzIDcuNTM5MDdMMy45MTgwMyA4LjAxOTE5TDYuODI3MzMgMTMuNzkwMUw1LjY3MjMzIDE0LjQ1NzFMMi43NjMzMyA4LjY4NTg2TDEuMjM2MzMgMTAuMzcwMVoiIGZpbGw9ImJsYWNrIi8+DQo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTExIDAuNjg3NUw2IDMuNzgxMjVMMTEgNi44NzVMMTYgMy43ODEyNUwxMSAwLjY4NzVaTTE0LjcyNSA1LjgyNzYxTDE0LjM0NjMgNS41OTMxN0wxNC45ODM3IDUuMTk4NTVMMTYgNS44Mjc2MUwxMSA4LjkyMTM2TDYgNS44Mjc2MUw3LjAxNjg4IDUuMTk4NTVMNy42NTQzOCA1LjU5MzE3TDcuMjc1IDUuODI3NjFMMTEgOC4xMzI4TDE0LjcyNSA1LjgyNzYxWk0xNiA3Ljg5MDNMMTQuOTcwNiA3LjI1Mjk5TDE0LjMzMzEgNy42NDc2MkwxNC43MjUgNy44OTAzTDExIDEwLjE5NTVMNy4yNzUgNy44OTAzTDcuNjY3NSA3LjY0NzYyTDcuMDMgNy4yNTI5OUw2IDcuODkwM0wxMSAxMC45ODQxTDE2IDcuODkwM1pNMTEgMS40NzcwNUw3LjI3NTAyIDMuNzgxNTVMMTEgNi4wODY3NEwxNC43MjUgMy43ODE1NUwxMSAxLjQ3NzA1WiIgZmlsbD0iYmxhY2siLz4NCjwvc3ZnPg0K"},62686:e=>{"use strict";e.exports=r},79244:e=>{"use strict";e.exports=a},1888:e=>{"use strict";e.exports=s},14321:e=>{"use strict";e.exports=n},76117:e=>{"use strict";e.exports=o}},t={};function i(a){var n=t[a];if(void 0!==n)return n.exports;var o=t[a]={exports:{}};return e[a](o,o.exports,i),o.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="";var l={};return i.p=window.jimuConfig.baseUrl,(()=>{"use strict";i.r(l),i.d(l,{__set_webpack_public_path__:()=>Je,default:()=>He});var e=i(79244),t=i(14321),a=i(45508),n=i.n(a),o=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]])}return a};const s=t=>{const a=window.SVG,{className:s}=t,r=o(t,["className"]),i=(0,e.classNames)("jimu-icon jimu-icon-component",s);return a?e.React.createElement(a,Object.assign({className:i,src:n()},r)):e.React.createElement("svg",Object.assign({className:i},r))},r={_widgetLabel:"Select",selectByData:"Select by data",selectingFeatures:"Selecting features",bufferUnit:"Buffer unit",selectByLocationFeatureCountTip:"There are {count} features inside this data.",attributeFilterBatchOnTip:"Apply all attribution for active layers",attributeFilterBatchOffTip:"Remove all attribution for active layers",allSelectable:"All selectable",noneSelectable:"None selectable",toggleAll:"Toggle all",buildCustomSQL:"Build custom SQL",customSQL:"Custom SQL",selectWidgetSelection:"{layerName} select widget selection",noLayersAvailableTip:"No layers are available to select.",openSettingPanelTip:"Please open the widget setting panel to update the configurations."};var c;!function(e){e.Intersects="Intersects",e.Contains="Contains",e.Crosses="Crosses",e.EnvelopeIntersects="EnvelopeIntersects",e.IndexIntersects="IndexIntersects",e.Overlaps="Overlaps",e.Touches="Touches",e.Within="Within"}(c||(c={}));const u={[c.Intersects]:"esriSpatialRelIntersects",[c.Contains]:"esriSpatialRelContains",[c.Crosses]:"esriSpatialRelCrosses",[c.EnvelopeIntersects]:"esriSpatialRelEnvelopeIntersects",[c.IndexIntersects]:"esriSpatialRelIndexIntersects",[c.Overlaps]:"esriSpatialRelOverlaps",[c.Touches]:"esriSpatialRelTouches",[c.Within]:"esriSpatialRelWithin"},d={[c.Intersects]:"spatialRelation_Intersect",[c.Contains]:"spatialRelation_Contain",[c.Crosses]:"spatialRelation_Cross",[c.EnvelopeIntersects]:"spatialRelation_EnvelopeIntersect",[c.IndexIntersects]:"spatialRelation_IndexIntersect",[c.Overlaps]:"spatialRelation_Overlap",[c.Touches]:"spatialRelation_Touch",[c.Within]:"spatialRelation_Within"};var p;!function(e){e.Miles="Miles",e.Kilometers="Kilometers",e.Feet="Feet",e.Meters="Meters",e.NauticalMiles="NauticalMiles"}(p||(p={}));const m={[p.Miles]:"miles",[p.Kilometers]:"kilometers",[p.Feet]:"feet",[p.Meters]:"feet",[p.NauticalMiles]:"nautical-miles"};var f;!function(e){e.Point="point",e.Polyline="polyline",e.Rectangle="rectangle",e.Circle="circle",e.Polygon="polygon"}(f||(f={}));var g,S=i(76117);function y(e,t,a,n){const o={};return a.forEach((a=>{const s=a.uid;if(n[s])return;const r=a.sqlExpression,i=I(t,r),l=D(null),c=j(""),u={uid:s,displayTitle:"",dataSource:null,jimuLayerView:null,isGenerated:t,shouldRenderFilterIcon:i,imDisplaySqlExpression:r,checked:!e,isSelecting:!1,latestSelectTaskInfo:{version:0,selectionMode:null,appliedGeometryInfo:l,appliedSql:c},isAttributeFilterOn:!1,tryExecuteSelectingByGeometryInfoAndSqlUI:null,enableAttributeFilter:null,clearSelection:null};o[s]=u})),o}function h(t,a){const n=(0,e.uuidv1)(),o=t.id;let s=o;const r=t.getMainDataSource();r&&(s=r.id);const i={uid:n,sqlHint:"",sqlExpression:null,useDataSource:{dataSourceId:o,mainDataSourceId:s},jimuLayerViewId:a};return(0,e.Immutable)(i)}function v(e,t){const a=function(e,t){const a=[];return e.forEach((e=>{const n=e.uid,o=t[n];o&&a.push({dataSourceItem:e,runtimeInfo:o})})),a}(e,t),n=[];return a.forEach((e=>{const{dataSourceItem:t,runtimeInfo:a}=e;t&&a&&a.displayTitle&&(t.jimuLayerViewId?a.jimuLayerView&&n.push(a):a.dataSource&&n.push(a))})),n}function w(e,t){return v(e,t).filter((e=>e.checked))}function b(e,t){return v(e,t).filter((e=>e.checked&&!e.isSelecting))}function I(e,t){let a=!1;return e?a=!0:t&&(a=!!j(t.sql)||M(e,t)),a}function M(e,t){let a=!1;return!e&&t&&(a=(0,S.getShownClauseNumberByExpression)(t)>0),a}function x(t,a,n){let o="";if(t&&a&&n){const t=e.dataSourceUtils.getArcGISSQL(a,n);t&&(o=t.sql)}return j(o)}function R(e){return"number"==typeof e&&e>0}function j(e){let t=e||"";return"1=1"===t&&(t=""),t}function D(e){return void 0===e?null:e}!function(e){e.Placeholder="Placeholder",e.Loading="Loading",e.NoLayersTip="NoLayersTip",e.Normal="Normal"}(g||(g={}));var N=i(60882),k=i.n(N),C=i(31579),L=i.n(C),E=i(14907),T=i.n(E),O=i(56509),A=i.n(O),V=i(9155),z=i.n(V),P=i(66364),B=i.n(P),F=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function i(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,i)}l((n=n.apply(e,t||[])).next())}))};const U=e.css`
  overflow: hidden;
  border-bottom: 1px solid var(--ref-palette-neutral-400);

  .dropdown-btn-container {
    position: relative;
    overflow: hidden;
    float: left;

    .api-modules-loading-progress {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      width: 100%;
      background-color: rgba(110,110,110,0.3);
      animation: esri-fade-in 500ms ease-in-out;
    }

    .api-modules-loading-progress:after {
      position: absolute;
      width: 20%;
      height: 2px;
      top: 0;
      content: "";
      opacity: 1;
      z-index: 0;
      background-color: var(--sys-color-primary-main);
      animation: looping-progresss-bar-ani 1500ms linear infinite;
      transition: opacity 500ms ease-in-out;
    }
  }

  .render-dropdown {
    .selected-tool-btn {
      border-right: 0;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .select-dropdown-btn {
      border-left: 0;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
  }

  .clear-all-btn {
    float: right;
  }
`,G="data",q={polygon:{mode:"hybrid"}},W={style:"esriSMSCircle",color:[0,0,128,128],name:"Circle",outline:{color:[0,0,128,255],width:1},type:"esriSMS",size:18},H={tags:["solid"],title:"Blue Thin",style:"esriSLSSolid",color:[79,129,189,255],width:3,name:"Blue 1",type:"esriSLS"},J={style:"esriSFSSolid",color:[79,129,189,77],type:"esriSFS",outline:{style:"esriSLSSolid",color:[54,93,141,255],width:1.5,type:"esriSLS"}};function $(a){var n,o,s;const{config:i,widgetId:l,mapWidgetId:c,autoControlWidgetId:u,activeJimuMapView:d,setSelectByLoactionVisible:p,allImDataSourceItems:m,dataSourceItemRuntimeInfoMap:g}=a,{useMap:S,interactiveTools:y,spatialSelection:h}=i,w=null==h?void 0:h.enable,I=e.hooks.useTranslation(t.defaultMessages,r),M=e.React.useRef(!1),[x,R]=e.React.useState(null),j=e.React.useRef(null);j.current=d;const[D,N]=e.React.useState(null),C=e.React.useMemo((()=>(null==D?void 0:D.view)||null),[D]),E=e.React.useRef(null),[O,V]=e.React.useState(!1),[P,$]=e.React.useState(!1),Z=e.React.useRef([]),Q=e.React.useRef(null),K=e.React.useRef(null),X=e.React.useRef("macOS"===(null===(o=null===(n=window.jimuUA)||void 0===n?void 0:n.os)||void 0===o?void 0:o.name)),ee=!(!x||!C),te=(null===(s=i.mapInfo)||void 0===s?void 0:s.enableAttributeSelection)||!1,ae=e.React.useMemo((()=>{let e="esriSpatialRelIntersects";return y&&!1===y.partiallyWithin&&(e="esriSpatialRelContains"),e}),[y]),ne=e.React.useMemo((()=>v(m,g)),[m,g]),oe=e.React.useMemo((()=>b(m,g)),[m,g]),se=e.React.useMemo((()=>({[f.Rectangle]:{order:1,label:I("SelectionByRectangle"),iconSrc:k()},[f.Polygon]:{order:2,label:I("SelectionByLasso"),iconSrc:L()},[f.Circle]:{order:3,label:I("SelectionByCircle"),iconSrc:T()},[f.Polyline]:{order:4,label:I("SelectionByLine"),iconSrc:A()},[f.Point]:{order:5,label:I("SelectionByPoint"),iconSrc:z()},[G]:{order:6,label:I("selectByData"),iconSrc:B()}})),[I]),re=e.React.useMemo((()=>{const e=[];return S&&y&&y.tools&&y.tools.length>0&&y.tools.forEach((t=>{e.push(t)})),w&&e.push(G),e.sort(((e,t)=>se[e].order-se[t].order)),e}),[y,w,se,S]),[ie,le]=e.React.useState(re[0]),ce=e.React.useMemo((()=>re.filter((e=>e!==G)).length>0),[re]),ue=ce&&!x,de=e.React.useMemo((()=>{let e="";if(ie){const t=se[ie];t&&(e=t.iconSrc)}return e}),[se,ie]),pe=e.React.useCallback((e=>e!==G&&!ee),[ee]),me=e.React.useMemo((()=>{const a=[];return re.forEach((n=>{n===G&&re.length>=2&&a.push((0,e.jsx)(t.DropdownItem,{key:"divider",divider:!0}));const o=n===ie,s=se[n].iconSrc,r=pe(n),i=(0,e.jsx)(t.DropdownItem,{key:n,active:o,disabled:r,onClick:()=>{le(n)}},(0,e.jsx)(t.SVG,{src:s,className:"mr-2"}),se[n].label);a.push(i)})),a}),[re,ie,se,pe]);e.React.useEffect((()=>{const e=X.current,t=t=>{"Shift"===t.key?Q.current={eventDate:new Date,isKeyDown:!0}:(e&&"Meta"===t.key||!e&&"Control"===t.key)&&(K.current={eventDate:new Date,isKeyDown:!0})},a=t=>{"Shift"===t.key?Q.current={eventDate:new Date,isKeyDown:!1}:(e&&"Meta"===t.key||!e&&"Control"===t.key)&&(K.current={eventDate:new Date,isKeyDown:!1})};return document.addEventListener("keydown",t,!0),document.addEventListener("keyup",a,!0),()=>{document.removeEventListener("keydown",t,!0),document.removeEventListener("keyup",a,!0)}}),[]),e.React.useEffect((()=>{const e=j.current;e&&e!==D&&e.whenJimuMapViewLoaded().then((()=>{e===j.current&&N(e)}))}),[d,D]),e.React.useEffect((()=>{!ce||x||M.current||(M.current=!0,(0,e.loadArcGISJSAPIModules)(["esri/widgets/Sketch/SketchViewModel","esri/layers/GraphicsLayer","esri/symbols/support/jsonUtils","esri/geometry/geometryEngine","esri/views/2d/interactive/editingTools","esri/views/3d/interactive/editingTools","esri/views/2d/layers/GraphicsLayerView2D","esri/views/3d/layers/GraphicsLayerView3D"]).then((e=>{const[t,a,n,o]=e;R({SketchViewModel:t,GraphicsLayer:a,jsonUtils:n,geometryEngine:o})})).catch((e=>{console.error("select widget loads api error",e)})))}),[x,M,ce]);const fe=e.React.useMemo((()=>ie&&ie!==G?ie:null),[ie]),ge=e.React.useMemo((()=>O&&ie&&ie!==G?ie:null),[O,ie]);e.hooks.useEffectWithPreviousValues((t=>{const[a,n]=t;if(l){if(ge!==a&&c)if(ge&&u!==l){const t=e.appActions.requestAutoControlMapWidget(c,l);(0,e.getAppStore)().dispatch(t)}else if(!ge&&u===l){const t=e.appActions.releaseAutoControlMapWidget(c);(0,e.getAppStore)().dispatch(t)}u!==n&&u!==l&&ge&&V(!1)}}),[ge,u,l]),e.React.useEffect((()=>{if(ie&&!re.includes(ie)){const e=re.length>0?re[0]:null;le(e),V(!1)}else if(!ie&&re.length>0){const e=re[0];le(e),V(!1)}}),[re,ie]);const Se=!(!S||te||!fe),ye=e.hooks.usePrevious(ge),he=null==x?void 0:x.geometryEngine,ve=e.React.useRef(null),we=e.React.useCallback(((t,a,n)=>{if(!a.geometry)return void console.log("sketch graphic.geometry is null");Se||(n=e.DataSourceSelectionMode.New);let o=a.geometry;try{if("point"===o.type||"polyline"===o.type){const e=10*(null==t?void 0:t.resolution);if(e>0&&he){const t=he.buffer(o,e,"meters");t&&(o=t)}}}catch(e){console.error("geometryEngine.buffer() error of Select widget",e)}const s=e.dataSourceUtils.changeJSAPIGeometryTypeToRestAPIGeometryType(o.type),r={geometry:o.toJSON(),geometryType:s,spatialRel:ae};Z.current=oe;(Z.current||[]).forEach((e=>F(this,void 0,void 0,(function*(){e.tryExecuteSelectingByGeometryInfoAndSqlUI(n,r)}))))}),[Se,ae,oe,he]);ve.current=we,e.React.useEffect((()=>{const t=E.current;let a=t;if(t){let e=!1;if(ge)if(ye===ge){const a=C||null,n=t.view||null;e=!a||a!==n}else e=!0;else e=!0;e&&(t&&Y(t),a=null)}const n=()=>{const e=E.current;if(e&&ge){const t=q[ge];t?e.create(ge,t):e.create(ge)}};if(x&&C&&ge&&!a){const t=C.on("key-down",(e=>{"Shift"===e.key&&e.stopPropagation()})),o=C.on("key-up",(e=>{"Shift"===e.key&&e.stopPropagation()})),{SketchViewModel:s,GraphicsLayer:r,jsonUtils:i}=x,l=new r;a=new s({view:C,layer:l,pointSymbol:i.fromJSON(W),polylineSymbol:i.fromJSON(H),polygonSymbol:i.fromJSON(J)}),a.viewKeyDownHandle=t,a.viewKeyUpHandle=o,a.on("create",(t=>{if("complete"===t.state&&(n(),ve.current)){const n=t.graphic,o=_(Q.current),s=_(K.current);let r=e.DataSourceSelectionMode.New;r=o?s?e.DataSourceSelectionMode.SelectFromCurrent:e.DataSourceSelectionMode.AddToCurrent:s?e.DataSourceSelectionMode.RemoveFromCurrent:e.DataSourceSelectionMode.New,ve.current(a.view,n,r)}}))}E.current=a,n()}),[ge,x,C,ye]),e.React.useEffect((()=>{p(O&&ie===G)}),[O,ie,p]),e.hooks.useUnmount((()=>{const e=E.current;e&&(Y(e),E.current=null)}));const be=e.React.useMemo((()=>{let e="";if(ie)if(ie===G)e="";else{let t="";t=ie===f.Point?I("SelectionByPoint"):ie===f.Rectangle?I("SelectionByRectangle"):ie===f.Polygon?I("SelectionByLasso"):ie===f.Circle?I("SelectionByCircle"):ie===f.Polyline?I("SelectionByLine"):I("SelectLabel");const a=I("newSelection"),n=I("addToCurrentSelection"),o=I("removeFromCurrentSelection"),s=I("selectFromCurrentSelection"),r=I("drawShape"),i=I("draw"),l=X.current?"Cmd":"Ctrl",c=`\u2219 ${a} (${r})`;e=Se?`${t}\n${c}\n${`\u2219 ${n} (Shift + ${i})`}\n${`\u2219 ${o} (${l} + ${i})`}\n${`\u2219 ${s} (Shift + ${l} + ${i})`}`:`${t}\n${c}`}return e}),[Se,ie,I]),Ie=e.React.useCallback((()=>{$((e=>!e))}),[$]),Me=e.React.useCallback((()=>{V(!O)}),[O]),xe=e.React.useCallback((()=>{ne.forEach((e=>{e.clearSelection&&e.clearSelection()}))}),[ne]),Re=me.length>=2;return(0,e.jsx)("div",{className:"w-100 p-4",css:U},(0,e.jsx)("div",{className:(0,e.classNames)(["d-flex align-items-center dropdown-btn-container",{"render-dropdown":Re}])},ie&&(0,e.jsx)(t.Button,{className:"selected-tool-btn",icon:!0,disabled:pe(ie),type:O?"primary":"default",title:be,onClick:Me},(0,e.jsx)(t.SVG,{src:de})),Re&&(0,e.jsx)(t.Dropdown,{activeIcon:!0,isOpen:P,toggle:Ie},(0,e.jsx)(t.DropdownButton,{className:"select-dropdown-btn",type:P?"primary":"default"}),(0,e.jsx)(t.DropdownMenu,{alignment:"start",offset:[0,4]},me)),ue&&(0,e.jsx)("div",{className:"api-modules-loading-progress"})),(0,e.jsx)(t.Button,{title:I("drawToolClearBtn"),className:"pl-4 pr-4 nowrap clear-all-btn",type:"default",icon:!0,onClick:xe},(0,e.jsx)("span",{className:"nowrap"},I("drawToolClearBtn"))))}function _(e){if(e){if(e.isKeyDown)return!0;return Date.now()-e.eventDate.getTime()<=500}return!1}function Y(e){e&&(e.viewKeyDownHandle&&(e.viewKeyDownHandle.remove(),e.viewKeyDownHandle=null),e.viewKeyUpHandle&&(e.viewKeyUpHandle.remove(),e.viewKeyUpHandle=null),e.destroyed||e.destroy())}var Z=i(25813),Q=i.n(Z),K=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]])}return a};const X=t=>{const a=window.SVG,{className:n}=t,o=K(t,["className"]),s=(0,e.classNames)("jimu-icon jimu-icon-component",n);return a?e.React.createElement(a,Object.assign({className:s,src:Q()},o)):e.React.createElement("svg",Object.assign({className:s},o))};var ee=i(4583),te=i.n(ee),ae=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]])}return a};const ne=t=>{const a=window.SVG,{className:n}=t,o=ae(t,["className"]),s=(0,e.classNames)("jimu-icon jimu-icon-component",n);return a?e.React.createElement(a,Object.assign({className:s,src:te()},o)):e.React.createElement("svg",Object.assign({className:s},o))};var oe=i(71690),se=i.n(oe),re=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]])}return a};const ie=t=>{const a=window.SVG,{className:n}=t,o=re(t,["className"]),s=(0,e.classNames)("jimu-icon jimu-icon-component",n);return a?e.React.createElement(a,Object.assign({className:s,src:se()},o)):e.React.createElement("svg",Object.assign({className:s},o))};var le=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function i(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,i)}l((n=n.apply(e,t||[])).next())}))};class ce{constructor(e,t){this.ds=e,this.widgetId=t}clearSelection(){return le(this,void 0,void 0,(function*(){const e=[];yield this.ds.selectRecords({widgetId:this.widgetId,records:e}),this.publishMessage(e)}))}selectRecords(t,a,n,o,s,r){return le(this,void 0,void 0,(function*(){Object.values(a).includes(a)&&(a=e.DataSourceSelectionMode.New);let i=null;const l=this.widgetId,c=this.ds;if(a!==e.DataSourceSelectionMode.New||t.objectIds||t.geometry||t.where&&"1=1"!==t.where){const u=yield e.dataSourceUtils.selectBySelectionMode({widgetId:l,ds:c,query:t,selectionMode:a,signal:n,checkLayerVisibility:!1,jimuLayerView:o,progressCallback:s,updateSelectionIfAborted:r});u&&(i=u.records)}else i=[],c.selectRecords({widgetId:l,records:i});i&&this.publishMessage(i)}))}publishMessage(t){const a=new e.DataRecordsSelectionChangeMessage(this.widgetId,t);e.MessageManager.getInstance().publishMessage(a)}}var ue=i(96300),de=i.n(ue),pe=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]])}return a};const me=t=>{const a=window.SVG,{className:n}=t,o=pe(t,["className"]),s=(0,e.classNames)("jimu-icon jimu-icon-component",n);return a?e.React.createElement(a,Object.assign({className:s,src:de()},o)):e.React.createElement("svg",Object.assign({className:s},o))};var fe=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function i(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,i)}l((n=n.apply(e,t||[])).next())}))};const ge=e.css`
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;

  .select-custom-sql-builder-header {
    padding: 16px;
  }

  .raw-sql-expression-builder {
    position: absolute;
    left: 16px;
    right: 16px;
    top: 53px;
    bottom: 16px;
    height: auto !important;
  }
`;function Se(a){const{isRTL:n,widgetId:o,widgetDomRef:s,dataSource:i,imSqlExpression:l,onBack:c}=a,u=null==s?void 0:s.current,d=e.hooks.useTranslation(t.defaultMessages,r),[p,m]=e.React.useState(null),[f,g]=e.React.useState(l),S=e.React.useCallback((()=>{c(f)}),[f,c]),y=e.React.useCallback((e=>{g(e)}),[g]);return e.React.useEffect((()=>{!function(){fe(this,void 0,void 0,(function*(){try{const t=yield e.moduleLoader.loadModules(["jimu-ui/advanced/sql-expression-builder"]);t&&t[0].SqlExpressionBuilder&&m(t[0].SqlExpressionBuilder)}catch(e){console.error("load SqlExpressionBuilder error",e)}}))}()}),[]),u?e.ReactDOM.createPortal((0,e.jsx)("div",{className:"select-custom-sql-builder surface-1 border-0",css:ge},(0,e.jsx)("div",{className:"select-custom-sql-builder-header"},(0,e.jsx)(t.Button,{type:"tertiary",size:"sm",icon:!0,onClick:S},(0,e.jsx)(me,{autoFlip:n})),(0,e.jsx)(t.Label,null,d("buildCustomSQL"))),p&&i&&(0,e.jsx)(p,{className:"raw-sql-expression-builder",dataSource:i,mode:e.SqlExpressionMode.Simple,widgetId:o,expression:f,noScrollForList:!0,queryScope:e.QueryScope.InRuntimeView,onChange:y})),u):null}var ye=i(1888);function he(a){const n="black",o=(0,ye.useTheme)(),s=e.React.useMemo((()=>e.css`
      display: inline-block;
      position: relative;
      width: 20px;
      height: 20px;
      background: transparent;

      .select-circle-progress {
        position: absolute;
        left: 0;
        top: 0;

        .progress-circle-bg {
          stroke: ${n};
          opacity: 0.3;
        }

        .progress-circle-progress {
          stroke: ${n};
          transition: none !important;
        }
      }

      .progress-stop {
        position: absolute;
        width: 6px;
        height: 6px;
        left: 7px;
        top: 7px;
        background: ${n};
      }

      .progress-mask {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: transparent;
      }
    `),[n]),i=e.hooks.useTranslation(t.defaultMessages,r),l=100*a.progress,c=parseFloat(l.toFixed(2)),u=i("selectingFeaturesTip");return(0,e.jsx)("div",{css:s,onClick:a.onClick,className:"select-progress",title:u},(0,e.jsx)(t.Progress,{className:"select-circle-progress",color:o.ref.palette.neutral[200],type:"circular",value:c,circleSize:20}),(0,e.jsx)("div",{className:"progress-stop"}),(0,e.jsx)("div",{className:"progress-mask"}))}var ve=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function i(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,i)}l((n=n.apply(e,t||[])).next())}))};function we(a){var n;const{isRTL:o,widgetId:s,widgetDomRef:i,enableDataAction:l,imDataSourceItem:c,itemRuntimeInfo:u,jimuMapView:d,updateDataSourceItemRuntimeInfoForUid:p,onDataRecordSetChange:m}=a,f=c.uid,g=c.useDataSource,y=c.sqlHint||"",h=c.sqlExpression,v=g.dataSourceId,w=c.jimuLayerViewId,b=u.displayTitle,N=u.dataSource,k=u.jimuLayerView,C=u.checked,L=u.imDisplaySqlExpression,E=(null===(n=u.latestSelectTaskInfo)||void 0===n?void 0:n.version)||0,T=u.shouldRenderFilterIcon,O=u.isAttributeFilterOn,A=u.isSelecting,V=u.isGenerated,z=V,P=e.hooks.useTranslation(t.defaultMessages,r),[B,F]=e.React.useState([]),U=B.length,G=e.React.useRef(null),[q,W]=e.React.useState(!1),[H,J]=e.React.useState(!1),$=e.React.useRef(u);$.current=u;const[_,Y]=e.React.useState(0),Z=e.React.useRef(null),Q=e.React.useRef(0),K=e.React.useMemo((()=>M(V,h)),[V,h]),ee=e.React.useMemo((()=>(V?P("customSQL"):y)||""),[y,V,P]),te=e.React.useMemo((()=>{var t,a,n,o,s;let r=null;if(N&&B.length>0){const i=N.getLabel()||"",l=P("selectWidgetSelection",{layerName:i});r={dataSource:N,name:l,type:"selected",records:B};let c=!1;const u=N.getInfo&&(null===(a=null===(t=N.getInfo())||void 0===t?void 0:t.selectOptions)||void 0===a?void 0:a.widgetId);if(u){const t=null===(o=null===(n=(0,e.getAppStore)())||void 0===n?void 0:n.getState())||void 0===o?void 0:o.appConfig;if(t&&t.widgets){const e=t.widgets[u],a=null==e?void 0:e.uri;"widgets/arcgis/arcgis-map/"!==a&&"widgets/common/select/"!==a||(c=!0)}}const d=N.getAllUsedFields()||[];let p=[];if(k&&c){const e=k.view;e&&(null===(s=e.availableFields)||void 0===s?void 0:s.length)>0&&(p=e.availableFields.slice())}p||(p=[]);let m=[].concat(d).concat(p);if(m=Array.from(new Set(m)),m.includes("*")){m=m.filter((e=>"*"!==e));const e=N.getSchema();if(null==e?void 0:e.fields){const t=Object.keys(null==e?void 0:e.fields);t.length>0&&(m=t)}}m&&m.length>0&&(r.fields=m)}return r}),[N,k,B,P]),ae=e.React.useMemo((()=>te?[te]:[]),[te]),[oe,se]=e.React.useState(!1),re=e.React.useMemo((()=>{const e=!w,t=R(E);return oe||e||t||T&&q&&K||T&&q&&H}),[H,q,oe,w,E,T,K]),le=e.React.useCallback((()=>ve(this,void 0,void 0,(function*(){let t=N;if(!t){const a=e.DataSourceManager.getInstance();if(t=a.getDataSource(g.dataSourceId),!t)try{t=yield a.createDataSourceByUseDataSource(g)}catch(e){t=null,console.error("create data source error",g.dataSourceId,e)}t&&p(f,{dataSource:t})}return t}))),[N,f,p,g]),ue=e.React.useCallback((()=>{var e,t;let a="";return N&&(a=N.getLabel()||(null===(e=N.getDataSourceJson())||void 0===e?void 0:e.sourceLabel)||""),a||k&&(a=null===(t=k.layer)||void 0===t?void 0:t.title),a||(a=""),a&&a!==b&&p(f,{displayTitle:a}),a}),[N,b,k,f,p]);e.React.useEffect((()=>{ue()}),[ue]),e.React.useEffect((()=>{if(!N){const t=e.DataSourceManager.getInstance().getDataSource(v);t&&p(f,{dataSource:t})}}),[N,v,f,p]),e.React.useEffect((()=>{re&&!N&&le()}),[N,le,re]),e.React.useEffect((()=>{if(w&&!k&&d&&0===w.indexOf(d.id)){function e(){return ve(this,void 0,void 0,(function*(){let e=null;try{e=yield d.whenJimuLayerViewLoaded(w)}catch(t){e=null,console.error("jimuLayerViewLoaded error",w,t)}if(e){const t=e.isLayerVisible();p(f,{checked:t,jimuLayerView:e})}}))}e()}}),[k,w,d,f,p]),e.React.useEffect((()=>{m(f,te)}),[te,m,f]);const de=e.React.useCallback(((t,a)=>{var n,o,r,i;let l=N;if(a){const c=(null===(n=null==t?void 0:t.selectedIds)||void 0===n?void 0:n.length)>0?null==t?void 0:t.selectedIds:null,u=(null===(o=a.selectedIds)||void 0===o?void 0:o.length)>0?a.selectedIds:null,d=(null===(r=a.selectOptions)||void 0===r?void 0:r.widgetId)||"";if(c!==u&&d!==s){const t=Z.current;if(t){const e=`Select widget: selection changed by other widget ${d}, abort current on-the-fly selecting task`;t.ignoreAbortedSelection=!0,t.abort(e)}const a={isAttributeFilterOn:!1};if(null===(i=$.current)||void 0===i?void 0:i.latestSelectTaskInfo){const t={version:$.current.latestSelectTaskInfo.version,selectionMode:e.DataSourceSelectionMode.New,appliedGeometryInfo:D(null),appliedSql:j("")};a.latestSelectTaskInfo=t}p(f,a)}if(a.instanceStatus!==e.DataSourceStatus.Created&&N)p(f,{dataSource:null});else if(a.instanceStatus===e.DataSourceStatus.Created){const t=e.DataSourceManager.getInstance().getDataSource(v);t&&t!==N&&(l=t,p(f,{dataSource:t}))}}let c=[];l&&(c=l.getSelectedRecords()||[],F(c)),F(c),ue()}),[N,v,s,f,p,ue]),pe=e.React.useRef();pe.current=de,e.React.useEffect((()=>{let t=null;const a=(0,e.getAppStore)().getState();return a&&a.dataSourcesInfo&&(t=a.dataSourcesInfo[v]),pe.current&&pe.current(t,t),G.current=(0,e.observeStore)(((e,t)=>{pe.current&&pe.current(e,t)}),["dataSourcesInfo",v]),()=>{G.current&&"function"==typeof G.current&&G.current(),G.current=null}}),[v]),e.React.useEffect((()=>{const e=$.current;if(!e)return;if(!N)return;const t=e.latestSelectTaskInfo;if(!t)return;const a=t.version;if(!R(a))return;if(a<=Q.current)return;Y(0),Z.current&&(Z.current.abort(`cancel selecting task ${Q.current} because need to execute a new one`),Z.current=null);const n=a;Q.current=n;const o=new AbortController;o.selectVersion=n,Z.current=o;const r=o.signal;let i=null;e.imDisplaySqlExpression&&(i=e.imDisplaySqlExpression.asMutable());const l={returnGeometry:!0,sqlExpression:i},c=t.appliedSql;c&&(l.where=c);const u=t.appliedGeometryInfo;u&&(l.geometry=u.geometry,l.geometryType=u.geometryType,l.spatialRel=u.spatialRel);const d=t.selectionMode,m=()=>$.current&&$.current.latestSelectTaskInfo.version===n,g=e=>{m()&&Y(e)},S=new ce(N,s),y=()=>{var e;const t=m(),a=null===(e=Z.current)||void 0===e?void 0:e.ignoreAbortedSelection;return t&&!a};!function(){ve(this,void 0,void 0,(function*(){try{yield S.selectRecords(l,d,r,k,g,y)}catch(e){console.error("Select widget select records error",e)}Z.current&&Z.current.selectVersion===n&&(Z.current=null),m()&&(p(f,{isSelecting:!1}),Y(1))}))}()}),[E,N,k,f,p,s]),e.React.useEffect((()=>{const e=I(V,h);p(f,{shouldRenderFilterIcon:e,imDisplaySqlExpression:h})}),[V,h,f,p]);const me=e.React.useCallback(((e,t)=>ve(this,void 0,void 0,(function*(){const a=$.current;if(!a)return;let n=a.dataSource;if(n||(n=yield le()),!n)return;t=D(t);const o=x(a.isAttributeFilterOn,a.imDisplaySqlExpression,n),s=a.latestSelectTaskInfo;if(s.version>0){const a=e===s.selectionMode,n=t===s.appliedGeometryInfo,r=o===s.appliedSql;if(a&&n&&r)return}const r=s.version+1;p(f,{latestSelectTaskInfo:{version:r,selectionMode:e,appliedGeometryInfo:t,appliedSql:o},isSelecting:!0})}))),[le,f,p]),fe=e.React.useRef();fe.current=me;const ge=e.React.useCallback((e=>{e=!!e,T&&p(f,{isAttributeFilterOn:e})}),[T,f,p]),ye=e.React.useCallback((()=>ve(this,void 0,void 0,(function*(){let t=N;if(t||(t=yield le()),!t)return;new ce(t,s).clearSelection();const a=$.current.latestSelectTaskInfo.version+1,n=D(null),o=j(""),r={version:a,selectionMode:e.DataSourceSelectionMode.New,appliedGeometryInfo:n,appliedSql:o};p(f,{latestSelectTaskInfo:r,isAttributeFilterOn:!1,isSelecting:!0})}))),[N,le,f,p,s]),we=e.React.useRef(!0);e.React.useEffect((()=>{const t=$.current;if(!t)return;const a=we.current;if(we.current=!1,!N&&!a)return void se(!0);const n=t.latestSelectTaskInfo;x(O,L,N)!==n.appliedSql&&fe.current&&fe.current(e.DataSourceSelectionMode.New,n.appliedGeometryInfo)}),[N,L,O]),e.React.useEffect((()=>{p(f,{tryExecuteSelectingByGeometryInfoAndSqlUI:me})}),[me,f,p]),e.React.useEffect((()=>{p(f,{enableAttributeFilter:ge})}),[ge,f,p]),e.React.useEffect((()=>{p(f,{clearSelection:ye})}),[ye,f,p]);const be=e.React.useCallback(((e,t)=>{p(f,{checked:t})}),[p,f]),Ie=e.React.useCallback((()=>{W(!q)}),[W,q]),Me=e.React.useCallback((()=>{ye()}),[ye]),xe=e.React.useCallback((()=>{const e=Z.current;e&&e.abort()}),[Z]),Re=e.React.useCallback((()=>{J(!0)}),[J]),je=e.React.useCallback(((e,t)=>{ge(t)}),[ge]),De=e.React.useCallback((e=>{const t=I(V,e);p(f,{shouldRenderFilterIcon:t,imDisplaySqlExpression:e})}),[V,p,f]),Ne=e.React.useCallback((e=>{De(e),J(!1)}),[De,J]),ke=e.React.useMemo((()=>{let t=38;T&&(t+=26),l&&(t+=26);const a=`${t}px`;let n=4;n+=A?20:4+10*U.toString().length+4;const o=`${n}px`;return e.css`
    .select-ds-list-item-top-row {
      position: relative;

      .ds-list-label-container {
        width: calc(100% - ${a});
        flex-basis: calc(100% - ${a});
        flex-shrink: 0;
        flex-grow: 0;

        .ds-list-label {
          max-width: calc(100% - ${o});
          flex-basis: auto;
          flex-shrink: 0;
          flex-grow: 0;

          .layer-name {
            width: calc(100% - 20px);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
          }
        }

        .selection-count-container {
          width: ${o};
          flex-basis: ${o};
          flex-shrink: 0;
          flex-grow: 0;

          .selection-count {
            display: inline;
            border-radius: 4px;
            background: var(--ref-palette-neutral-300);
            padding: 1px 4px 0px 4px;
            line-height: 16px;
            font-size: 12px;
          }
        }
      }

      .ds-list-icons {
        box-sizing: border-box;
        flex-direction: row-reverse;
        width: ${a};
        flex-basis: ${a};
        flex-shrink: 0;
        flex-grow: 0;
      }
    }

    .select-sql-hint {
      word-break: break-all;
    }

    .sql-expr-runtime-disabled {
      touch-action: none;
      pointer-events: none;
    }
  `}),[l,A,U,T]);return b?(0,e.jsx)("div",{className:(0,e.classNames)(["select-ds-list-item w-100 mt-2",{"filer-panel-opened":q}]),css:ke},(0,e.jsx)("div",{className:"select-ds-list-item-top-row w-100 d-flex align-items-center"},(0,e.jsx)("div",{className:"ds-list-label-container d-flex align-items-center"},(0,e.jsx)(t.Label,{className:"ds-list-label d-flex align-items-center mb-0"},(0,e.jsx)(t.Checkbox,{checked:C,className:"mr-1",onChange:be}),(0,e.jsx)("span",{className:"layer-name",title:b},b)),(0,e.jsx)("div",{className:"selection-count-container d-flex align-items-center pl-1"},!A&&U>0&&(0,e.jsx)("div",{className:"selection-count"},U),A&&(0,e.jsx)(he,{progress:_,onClick:xe}))),(0,e.jsx)("div",{className:"ds-list-icons d-flex align-items-center"},l&&(0,e.jsx)(t.DataActionList,{widgetId:s,dataSets:ae,disableDataSourceLevelActions:!0,buttonType:"tertiary",listStyle:t.DataActionListStyle.Dropdown,hideGroupTitle:!0}),(0,e.jsx)(t.Button,{title:P("clearSelection"),type:"tertiary",size:"sm",icon:!0,onClick:Me},(0,e.jsx)(ne,{size:16})),T&&(0,e.jsx)(t.Button,{title:P("attributeSelection"),type:q?"primary":"tertiary",size:"sm",icon:!0,onClick:Ie},(0,e.jsx)(ie,{width:16,height:16})))),T&&(0,e.jsx)("div",{className:(0,e.classNames)(["filter-panel w-100",{"d-none":!q}])},(0,e.jsx)("div",{className:"d-flex w-100 align-items-center mt-3"},(0,e.jsx)("label",{className:"w-100 pb-0 pr-1 select-sql-hint"},ee),z&&(0,e.jsx)(t.Button,{title:P("customSQL"),type:"tertiary",size:"sm",icon:!0,onClick:Re},(0,e.jsx)(X,null)),(0,e.jsx)(t.Switch,{disabled:A,checked:O,onChange:je})),K&&N&&(0,e.jsx)(S.SqlExpressionRuntime,{className:(0,e.classNames)([{"sql-expr-runtime-disabled":A}]),widgetId:s,dataSource:N,expression:L,onChange:De}),H&&N&&(0,e.jsx)(Se,{isRTL:o,widgetId:s,widgetDomRef:i,dataSource:N,imSqlExpression:L,onBack:Ne}))):null}var be=i(13424),Ie=i.n(be),Me=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]])}return a};const xe=t=>{const a=window.SVG,{className:n}=t,o=Me(t,["className"]),s=(0,e.classNames)("jimu-icon jimu-icon-component",n);return a?e.React.createElement(a,Object.assign({className:s,src:Ie()},o)):e.React.createElement("svg",Object.assign({className:s},o))};function Re(a){const{isRTL:n,widgetId:o,widgetDomRef:s,jimuMapView:i,enableDataAction:l,allImDataSourceItems:c,generatedImDataSourceItems:u,configDataSourceItems:d,dataSourceItemRuntimeInfoMap:p,updateDataSourceItemRuntimeInfoForUid:m}=a,f=e.hooks.useTranslation(t.defaultMessages,r),[g,S]=e.React.useState(!1),[y,h]=e.React.useState({}),v=e.React.useRef(null),b=e.React.useMemo((()=>function(e,t){const a=[];return e.forEach((e=>{const n=e.uid,o=t[n];o&&a.push(o)})),a}(c,p)),[p,c]),I=e.React.useCallback((()=>{S((e=>!e))}),[S]),M=e.React.useCallback((()=>{S(!1)}),[S]),x=e.React.useCallback((()=>{S(!1),b.forEach((e=>{e.checked||m(e.uid,{checked:!0})}))}),[b,m]),R=e.React.useCallback((()=>{S(!1),b.forEach((e=>{e.checked&&m(e.uid,{checked:!1})}))}),[b,m]),j=e.React.useCallback((()=>{S(!1),b.forEach((e=>{m(e.uid,{checked:!e.checked})}))}),[b,m]),D=e.React.useCallback(((e,t)=>{h((a=>Object.assign({},a,{[e]:t})))}),[h]),N=e.React.useCallback((e=>e.filter((e=>{const t=e.uid;return!!p[t]}))),[p]),k=e.React.useMemo((()=>N(u)),[u,N]),C=e.React.useMemo((()=>N(d)),[d,N]),L=e.React.useMemo((()=>{const e=w(c,p),t={};e.forEach((e=>{const a=null==e?void 0:e.uid;a&&(t[a]=!0)}));const a=[];return Object.keys(y).forEach((e=>{if(t[e]){const t=y[e];t&&a.push(t)}})),a}),[c,p,y]),E=e.React.useMemo((()=>e.css`
      .layers-header-tip {
        font-size: 0.875rem;
        color: var(--ref-palette-neutral-1100);
        font-weight: 600;
      }
    `),[]);return(0,e.jsx)("div",{className:"data-attribute-select p-4",css:E},(0,e.jsx)("div",{className:"w-100 d-flex align-items-center"},(0,e.jsx)(t.Button,{className:"pl-0 pr-2",type:"tertiary",size:"sm",icon:!0,ref:v,onClick:I},(0,e.jsx)(xe,{width:16,height:16})),(0,e.jsx)(t.Label,{className:"layers-header-tip mb-0 w-100"}," ",f("layers")," "),l&&(0,e.jsx)(t.DataActionList,{widgetId:o,dataSets:L,disableDataSourceLevelActions:!0,buttonType:"tertiary",listStyle:t.DataActionListStyle.Dropdown,hideGroupTitle:!0,alwaysShowBatchIcon:!0})),(0,e.jsx)("div",{className:"ds-list-items"},k.map((t=>{const a=t.uid,r=p[a];return(0,e.jsx)(we,{key:a,isRTL:n,widgetId:o,widgetDomRef:s,jimuMapView:i,enableDataAction:l,imDataSourceItem:t,itemRuntimeInfo:r,updateDataSourceItemRuntimeInfoForUid:m,onDataRecordSetChange:D})}))),(0,e.jsx)("div",{className:"ds-list-items"},C.map((t=>{const a=t.uid,r=p[a];return(0,e.jsx)(we,{key:a,isRTL:n,widgetId:o,widgetDomRef:s,jimuMapView:i,enableDataAction:l,imDataSourceItem:t,itemRuntimeInfo:r,updateDataSourceItemRuntimeInfoForUid:m,onDataRecordSetChange:D})}))),(0,e.jsx)(t.Popper,{reference:v,floating:!1,open:g,showArrow:!1,toggle:M},(0,e.jsx)("div",{className:"d-flex flex-column"},(0,e.jsx)(t.Button,{type:"tertiary",className:"text-left",onClick:x},f("allSelectable")),(0,e.jsx)(t.Button,{type:"tertiary",className:"text-left",onClick:R},f("noneSelectable")),(0,e.jsx)(t.Button,{type:"tertiary",className:"text-left",onClick:j},f("toggleAll")))))}var je=i(62686),De=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function i(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,i)}l((n=n.apply(e,t||[])).next())}))};function Ne(a){const{widgetId:n,visible:o,allImDataSourceItems:s,dataSourceItemRuntimeInfoMap:i,imSpatialSelection:l,updateDataSourceItemRuntimeInfoForUid:c}=a,f=l.buffer;let g=!1,S=0,y=null;f&&(g=f.enable,S=f.distance,y=f.unit),"number"!=typeof S&&(S=0),y||(y=p.Meters);const[h,v]=e.React.useState({}),[I,M]=e.React.useState(l.relationships&&l.relationships[0]),[x,R]=e.React.useState(""),[j,D]=e.React.useState(S),[N,k]=e.React.useState(y),[C,L]=e.React.useState(-1),[E,T]=e.React.useState(!1),O=e.React.useRef([]),A=e.hooks.useTranslation(t.defaultMessages,r);e.React.useEffect((()=>{"number"==typeof S&&D(S)}),[S]),e.React.useEffect((()=>{y&&k(y)}),[y]);const V=e.React.useMemo((()=>e.css`
      border-bottom: 1px solid var(--ref-palette-neutral-400);

      .select-by-location-title {
        font-size: 0.875rem;
        color: var(--ref-palette-neutral-1100);
        font-weight: 600;
      }

      .select-by-location-param-title {
        font-weight: 500;
      }

      .feature-count-info {
        background: var(--primary-100, #E6F2FF);
        border-color: var(--info-300, #60CEFF);
        border-width: 1px;
        border-style: solid;
        min-height: 32px;
      }
    `),[]),z=e.React.useMemo((()=>{if(!x)return null;return h[x]||e.DataSourceManager.getInstance().getDataSource(x)}),[h,x]),P=e.React.useMemo((()=>{let e=null;return z&&(e=z.getMainDataSource()),e}),[z]),B=e.React.useMemo((()=>w(s,i).length),[s,i]),F=e.React.useMemo((()=>b(s,i)),[s,i]),U=F.length,G=e.React.useMemo((()=>{let e=I&&z&&!E&&B>0&&B===U;return e=!!e,e}),[E,B,U,I,z]),q=e.React.useCallback((()=>{O.current=F;const e=O.current||[];T(!0),e.forEach((e=>{const t=e.uid;c(t,{isSelecting:!0})}))}),[O,F,c]),W=e.React.useCallback((t=>{const a=O.current||[];O.current=[],T(!1),a.forEach((a=>De(this,void 0,void 0,(function*(){a.tryExecuteSelectingByGeometryInfoAndSqlUI(e.DataSourceSelectionMode.New,t)}))))}),[O,T]),H=e.React.useCallback((()=>{const e=O.current||[];O.current=[],T(!1),e.forEach((e=>{const t=e.uid;c(t,{isSelecting:!1})}))}),[O,T,c]),J=e.React.useCallback((()=>{if(!I)return;if(!z)return;q();const t=function(e,t,a,n){return De(this,void 0,void 0,(function*(){const o={outFields:[],returnGeometry:!0,outSR:102100},s=yield e.ds.queryAll(o),r=yield(0,je.loadArcGISJSAPIModules)(["esri/geometry/support/jsonUtils","esri/geometry/geometryEngineAsync"]),[i,l]=r,c=[];s&&s.records.length>0&&s.records.forEach((e=>{const t=e.getGeometry();if(t)if(t.declaredClass)c.push(t);else{const e=i.fromJSON(t);c.push(e)}}));let u=null;if(c.length>0)if(t&&a>0&&n){const e=m[n],t=!0,o=yield l.buffer(c,[a],e,t);u=Array.isArray(o)?o[0]:o}else u=1===c.length?c[0]:yield l.union(c);return u}))}(new ce(z,n),g,j,N);t.then((t=>{const a=e.dataSourceUtils.changeJSAPIGeometryTypeToRestAPIGeometryType(t.type),n=u[I],o={geometry:t.toJSON(),geometryType:a,spatialRel:n};W(o)})).catch((e=>{console.error("can not get buffered union geometry",e),H()}))}),[j,N,g,H,W,q,I,z,n]);e.React.useEffect((()=>{L(-1),z&&z.queryCount({}).then((e=>{if(z.id===x){const t=(null==e?void 0:e.count)||0;L(t)}})).catch((e=>{console.error("query count error for location data source",e)}))}),[z,x]);const $=e.React.useCallback((e=>{if(z&&z.id===x&&ke(z)){const t=(null==e?void 0:e.length)||0;L(t)}}),[z,x]),_=e.React.useCallback((e=>{const t=e.target.value;M(t)}),[M]),Y=e.React.useCallback((e=>{const t=e.target.value;R(t)}),[R]),Z=e.React.useCallback((e=>{e&&v((t=>{const a=e.id;return Object.assign({},t,{[a]:e})}))}),[v]),Q=e.React.useCallback((e=>{D(e)}),[D]),K=e.React.useCallback((e=>{const t=e.target.value;k(t)}),[k]),X=e.React.useMemo((()=>{const e=[];return l.useDataSources.forEach((t=>{const a=t.dataSourceId,n=h[a];n&&e.push(n)})),e}),[h,l.useDataSources]),ee=A("selectByData"),te=A("apply"),ae=A("relationship"),ne=A("selectingFeatures"),oe=A("theBufferDistance"),se=A("bufferUnit"),re=A("selectByLocationFeatureCountTip",{count:C});return(0,e.jsx)("div",{className:(0,e.classNames)(["select-by-location p-4",{"d-none":!o}]),css:V},(0,e.jsx)("div",{className:"d-flex w-100 align-items-center mb-2"},(0,e.jsx)("label",{className:"select-by-location-title w-100 mb-0",title:ee},ee),(0,e.jsx)(t.Button,{className:"nowrap",type:"primary",disabled:!G,size:"sm",onClick:J},te)),(0,e.jsx)("div",{className:"relationship-param w-100 d-flex flex-column align-items-center mb-2"},(0,e.jsx)("label",{className:"select-by-location-param-title w-100 mb-2",title:ae},ae),(0,e.jsx)(t.Select,{className:"relationship-select w-100",size:"sm",value:I,"aria-label":ae,onChange:_},l.relationships.map((t=>(0,e.jsx)("option",{key:t,value:t},A(d[t])))))),(0,e.jsx)("div",{className:"data-view-param w-100 d-flex flex-column align-items-center mb-2"},(0,e.jsx)("label",{className:"select-by-location-param-title w-100 mb-2",title:ne},ne),(0,e.jsx)(t.Select,{className:"selecting-features-select w-100",size:"sm",value:x,"aria-label":ne,onChange:Y},X.map((t=>(0,e.jsx)("option",{key:t.id,value:t.id},t.getLabel()||"")))),l.useDataSources.map((t=>(0,e.jsx)(e.DataSourceComponent,{key:t.dataSourceId,useDataSource:t,onDataSourceCreated:Z})))),z&&P&&ke(z)&&(0,e.jsx)(e.DataSourceComponent,{dataSource:P,onSelectionChange:$}),g&&(0,e.jsx)("div",{className:"distance-unit-param w-100 d-flex flex-column align-items-center"},(0,e.jsx)("label",{className:"select-by-location-param-title w-100 mb-2",title:oe},oe),(0,e.jsx)("div",{className:"d-flex w-100 justify-content-between"},(0,e.jsx)(t.NumericInput,{className:"distance-input w-45 mr-1","aria-label":oe,size:"sm",value:j,min:0,onChange:Q}),(0,e.jsx)(t.Select,{className:"unit-select w-55",size:"sm",value:N,"aria-label":se,onChange:K},Object.values(p).map((t=>(0,e.jsx)("option",{key:t,value:t},A(`unit_${t}`))))))),C>=0&&(0,e.jsx)(t.Alert,{type:"info",withIcon:!0,text:re,className:"w-100 mt-3","aria-live":"polite",buttonType:"default",closable:!1,form:"basic",open:!0,size:"medium"}))}function ke(t){return!!t&&(t.isDataView&&t.dataViewId===e.CONSTANTS.SELECTION_DATA_VIEW_ID)}const Ce=[e.DataSourceTypes.FeatureLayer,e.DataSourceTypes.SceneLayer,e.DataSourceTypes.BuildingComponentSubLayer,e.DataSourceTypes.OrientedImageryLayer,e.DataSourceTypes.ImageryLayer];(0,e.Immutable)(Ce);function Le(e){return Ce.includes(e)}const Ee=[je.LayerTypes.FeatureLayer,je.LayerTypes.SceneLayer,je.LayerTypes.BuildingComponentSublayer,je.LayerTypes.OrientedImageryLayer,je.LayerTypes.ImageryLayer];function Te(t){const{isRTL:a,className:n,widgetProps:o,widgetDomRef:s,dataSourceItemRuntimeInfoMap:r,mixinDataSourceItemRuntimeInfoMap:i,updateDataSourceItemRuntimeInfoForUid:l,updateWidgetDisplayMode:c}=t,{widgetId:u,config:d,dataSourceCount:p,autoControlWidgetId:m}=o,{dataAttributeInfo:f,spatialSelection:S}=d,{allowGenerated:w,dataSourceItems:b}=f,I=!1!==o.enableDataAction,M=!!(null==S?void 0:S.enable),[x,R]=e.React.useState(!1),[j,D]=e.React.useState((0,e.Immutable)([])),N=e.React.useMemo((()=>j.concat(b)),[b,j]);e.React.useEffect((()=>{let e=null;if(N.length>0){e=v(N,r).length>0?g.Normal:g.Loading}else e=g.Placeholder;c(e)}),[N,r,c]),e.React.useEffect((()=>{if(!w)return void(0!==j.length&&D((0,e.Immutable)([])));const t=(0,e.getAppStore)().getState().dataSourcesInfo||(0,e.Immutable)({}),a=e.DataSourceManager.getInstance(),n=j.map((e=>e.useDataSource.dataSourceId)).asMutable(),o=[];Object.keys(t).forEach((e=>{if(e.includes("view_in_table"))return;const t=a.getDataSource(e);if(t){const e=t.isAssociatedFeatureLayer;t.isInAppConfig()||t.isDataView||t.isLocal||e||Le(t.type)&&o.push(t.id)}}));const{added:s,deleted:l,saved:c}=e.utils.diffArrays(!0,n,o);if(0===s.length&&0===l.length)return;const u=j.filter((e=>{const t=e.useDataSource.dataSourceId;return c.includes(t)})),d=[];if(s.length>0){s.forEach((e=>{const t=a.getDataSource(e);if(t){const e=h(t);d.push(e)}}));const e=y(!1,!0,d,r);i(e)}const p=u.concat(d);D(p)}),[p,w,j,i,D,r]),e.React.useEffect((()=>{const e=b.filter((e=>{const t=e.uid;return!r[t]}));if(e.length>0){const t=y(!1,!1,e,r);i(t)}}),[b,r,i]);const k=["select-use-data-source-entry"];n&&k.push(n);const C=k.join(" ");return e.React.createElement("div",{className:C},e.React.createElement($,{config:d,widgetId:u,mapWidgetId:"",autoControlWidgetId:m,activeJimuMapView:null,setSelectByLoactionVisible:R,allImDataSourceItems:N,dataSourceItemRuntimeInfoMap:r}),M&&e.React.createElement(Ne,{widgetId:u,visible:x,allImDataSourceItems:N,dataSourceItemRuntimeInfoMap:r,imSpatialSelection:S,updateDataSourceItemRuntimeInfoForUid:l}),e.React.createElement(Re,{isRTL:a,widgetId:u,widgetDomRef:s,jimuMapView:null,enableDataAction:I,allImDataSourceItems:N,generatedImDataSourceItems:j,configDataSourceItems:b,dataSourceItemRuntimeInfoMap:r,updateDataSourceItemRuntimeInfoForUid:l}))}var Oe=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function i(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,i)}l((n=n.apply(e,t||[])).next())}))};function Ae(t){const{isRTL:a,className:n,widgetProps:o,widgetDomRef:s,dataSourceItemRuntimeInfoMap:r,mixinDataSourceItemRuntimeInfoMap:i,updateDataSourceItemRuntimeInfoForUid:l,updateWidgetDisplayMode:c}=t,{widgetId:u,config:d,dataSourceCount:p,mapWidgetId:m,autoControlWidgetId:f}=o,{mapInfo:S,spatialSelection:w}=d,b=!1!==o.enableDataAction,I=!!(null==w?void 0:w.enable),M=S.jimuMapViews,x=!!S.allowGenerated,[R,j]=e.React.useState(!1),D=e.React.useRef(x);D.current=x;const N=e.hooks.usePrevious(x),[k,C]=e.React.useState(null),L=e.hooks.usePrevious(k),E=k?k.id:"",[T,O]=e.React.useState((0,e.Immutable)([])),A=e.React.useRef(),V=e.React.useCallback((()=>{if(!x||!k)return void(0!==T.length&&O((0,e.Immutable)([])));const t=e.DataSourceManager.getInstance(),a=T.map((e=>e.useDataSource.dataSourceId)).asMutable(),n=[];Ve(k).forEach((e=>{const t=e.getLayerDataSource();t&&Le(t.type)&&n.push(t.id)}));const{added:o,deleted:s,saved:l}=e.utils.diffArrays(!0,a,n);if(0===o.length&&0===s.length)return;const c=T.filter((e=>{const t=e.useDataSource.dataSourceId;return l.includes(t)})),u=[];if(o.length>0){o.forEach((e=>{const a=t.getDataSource(e);if(a){const e=k.getJimuLayerViewByDataSourceId(a.id),t=h(a,null==e?void 0:e.id);u.push(t)}}));const e=y(!0,!0,u,r);i(e)}const d=c.concat(u);O(d)}),[k,x,r,T,i]);A.current=V,e.React.useEffect((()=>{N!==x&&A.current&&A.current()}),[N,x,A]),e.React.useEffect((()=>{var e,t;if(L!==k){const e=Ve(k).map((e=>{const t=e.getLayerDataSource();return t?Promise.resolve(t):e.createLayerDataSource()}));Promise.all(e).finally((()=>{A.current&&A.current()}))}const a=e=>Oe(this,void 0,void 0,(function*(){if(D.current&&e&&ze(e)&&Pe(e)){let t=e.getLayerDataSource();if(!t)try{t=yield e.createLayerDataSource()}catch(t){console.error(`fail to create data source for JimuMapView ${e.id}`,t)}t&&Le(t.type)&&A.current&&A.current()}}));let n=null;if(k){k.addJimuLayerViewCreatedListener(a);const o=null===(t=null===(e=k.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.layers;o&&(n=o.on("after-remove",(e=>{const t=e.item;if(t){const e=k.getJimuLayerViewByAPILayer(t);e&&e.fromRuntime&&A.current&&A.current()}})))}return()=>{k&&k.removeJimuLayerViewCreatedListener(a),n&&(n.remove(),n=null)}}),[L,k,A]),e.React.useEffect((()=>{A.current&&A.current()}),[p]);const z=e.React.useMemo((()=>{let t=null;if(M&&E){const e=M[E];e&&e.length>0&&(t=e)}return t||(t=(0,e.Immutable)([])),t}),[E,M]),P=e.React.useMemo((()=>T.concat(z)),[z,T]);e.React.useEffect((()=>{let e=null;if(m){let t=0;if(M&&Object.values(M).forEach((e=>{e&&e.length>0&&(t+=e.length)})),0===T.length&&0===t)e=g.NoLayersTip;else if(E)if(P.length>0){e=v(P,r).length>0?g.Normal:g.Loading}else e=g.NoLayersTip;else e=g.Loading}else e=g.Placeholder;c(e)}),[E,P,r,T.length,M,c,m]),e.React.useEffect((()=>{const e=z.filter((e=>{const t=e.uid;return!r[t]}));if(e.length>0){const t=y(!0,!1,e,r);i(t)}}),[z,r,i]);const B=e.React.useCallback((e=>{C(e)}),[C]),F=["select-use-map-entry"];n&&F.push(n);const U=F.join(" ");return e.React.createElement("div",{className:U},m&&e.React.createElement(je.JimuMapViewComponent,{useMapWidgetId:m,onActiveViewChange:B}),e.React.createElement($,{config:d,widgetId:u,mapWidgetId:m,autoControlWidgetId:f,activeJimuMapView:k,setSelectByLoactionVisible:j,allImDataSourceItems:P,dataSourceItemRuntimeInfoMap:r}),I&&e.React.createElement(Ne,{widgetId:u,visible:R,allImDataSourceItems:P,dataSourceItemRuntimeInfoMap:r,imSpatialSelection:w,updateDataSourceItemRuntimeInfoForUid:l}),e.React.createElement(Re,{isRTL:a,widgetId:u,widgetDomRef:s,jimuMapView:k,enableDataAction:b,allImDataSourceItems:P,generatedImDataSourceItems:T,configDataSourceItems:z,dataSourceItemRuntimeInfoMap:r,updateDataSourceItemRuntimeInfoForUid:l}))}function Ve(e){const t=[];return e&&Object.values(e.jimuLayerViews).forEach((e=>{e&&ze(e)&&Pe(e)&&t.push(e)})),t}function ze(e){const t=!!(e&&e.fromRuntime&&function(e){if(!e||!e.type)return!1;const t=e.type,a=t!==je.LayerTypes.BuildingComponentSublayer||t===je.LayerTypes.BuildingComponentSublayer&&e.view;return!(!Ee.includes(t)||!a)}(e));return t}function Pe(e){var t,a,n;if(e){const o=e.getJimuMapView(),s=(null===(n=null===(a=null===(t=null==o?void 0:o.view)||void 0===t?void 0:t.map)||void 0===a?void 0:a.layers)||void 0===n?void 0:n.toArray())||[],r=function(e){let t=null;if(e){const a=e.getJimuMapView();if(a){const n=a.getParentJimuLayerViews(e.id);t=n.length>0?n[n.length-1]:e}}return t}(e),i=null==r?void 0:r.layer;if((null==s?void 0:s.length)>0&&i)return s.includes(i)}return!1}var Be=i(32772),Fe=i.n(Be);class Ue extends e.WidgetVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.15.0",description:"remove useless useDataSources from Select widget",upgradeFullInfo:!0,upgrader:e=>{var t,a,n;const o=null==e?void 0:e.widgetJson,s=null==o?void 0:o.config;if(!s)return e;let r=s;if(r.useMap)(null===(a=null===(t=r.dataAttributeInfo)||void 0===t?void 0:t.dataSourceItems)||void 0===a?void 0:a.length)>0&&(r=r.setIn(["dataAttributeInfo","dataSourceItems"],[]));else{const e=null===(n=r.mapInfo)||void 0===n?void 0:n.jimuMapViews;e&&Object.keys(e).length>0&&(r=r.setIn(["mapInfo","jimuMapViews"],{}))}if(s===r)return e;const i=function(e){const t=[];e.dataAttributeInfo&&e.dataAttributeInfo.dataSourceItems&&e.dataAttributeInfo.dataSourceItems.length>0&&e.dataAttributeInfo.dataSourceItems.forEach((e=>{const a=e.useDataSource.asMutable();t.push(a)})),e.mapInfo&&e.mapInfo.jimuMapViews&&Object.values(e.mapInfo.jimuMapViews).forEach((e=>{e&&e.length>0&&e.forEach((e=>{const a=e.useDataSource.asMutable();t.push(a)}))})),e.spatialSelection&&e.spatialSelection.useDataSources&&e.spatialSelection.useDataSources.length>0&&e.spatialSelection.useDataSources.forEach((e=>{const a=e.asMutable();t.push(a)}));const a=[],n=[];return t.forEach((e=>{const t=e.dataSourceId;a.includes(t)||(a.push(t),n.push(e))})),n}(r),l=o.set("config",r).set("useDataSources",i),c=Object.assign({},e);return c.widgetJson=l,c}}]}}const Ge=new Ue,qe=e.css`
  position: relative;
  overflow-x: hidden;
  overflow-y: auto;

  .nowrap {
    white-space: nowrap;
    text-wrap: nowrap;
  }

  .no-layers-panel-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding-left: 50px;
    padding-right: 50px;
  }
`,We=a=>{var n;const{isRTL:o,widgetId:i,config:l}=a,{useMap:c,dataAttributeInfo:u,mapInfo:d}=l,p=e.hooks.useTranslation(t.defaultMessages,r),m=e.React.useRef(),[f,S]=e.React.useState(g.Placeholder),y=e.React.useRef(f);y.current=f;const h=e.React.useRef(!1),v=e.React.useRef(null),[w,b]=e.React.useState({}),I=e.React.useCallback((e=>{if(e!==y.current){if(e===g.Loading){if(h.current)return;h.current=!0,v.current||(v.current=setTimeout((()=>{y.current===g.Loading&&S(g.NoLayersTip)}),2e4))}S(e)}}),[]);e.React.useEffect((()=>()=>{v.current&&clearTimeout(v.current)}),[]);const M=e.React.useCallback((e=>{e&&0!==Object.keys(e).length&&b((t=>Object.assign({},t,e)))}),[b]),x=e.React.useCallback(((e,t)=>{b((a=>{const n=a[e];if(!n)return;const o=Object.assign({},n,t),s=Object.assign({},a);return s[e]=o,s}))}),[b]),R=e.React.useMemo((()=>{var e;let t=[];if(c){if(d&&d.jimuMapViews){Object.keys(d.jimuMapViews).forEach((e=>{const a=d.jimuMapViews[e];a&&a.length>0&&a.forEach((e=>{const a=e.uid;a&&t.push(a)}))}))}}else u&&(null===(e=u.dataSourceItems)||void 0===e?void 0:e.length)>0&&u.dataSourceItems.forEach((e=>{const a=e.uid;a&&t.push(a)}));return t=Array.from(new Set(t)),t}),[c,d,u]),j=e.hooks.usePrevious(R)||[],{deleted:D}=e.utils.diffArrays(!0,j,R);e.React.useEffect((()=>{D&&D.length>0&&b((e=>{const t=Object.assign({},e);let a=!1;return D.forEach((e=>{t[e]&&(delete t[e],a=!0)})),a?t:e}))}),[D]);const N=f!==g.Placeholder,k=(0,e.classNames)(["jimu-widget widget-select border-0"],{"surface-1":N});return(0,e.jsx)("div",{ref:m,className:k,css:qe},!c&&(0,e.jsx)(Te,{isRTL:o,className:f===g.Normal?"":"d-none",widgetProps:a,widgetDomRef:m,dataSourceItemRuntimeInfoMap:w,mixinDataSourceItemRuntimeInfoMap:M,updateDataSourceItemRuntimeInfoForUid:x,updateWidgetDisplayMode:I}),c&&(0,e.jsx)(Ae,{isRTL:o,className:f===g.Normal?"":"d-none",widgetProps:a,widgetDomRef:m,dataSourceItemRuntimeInfoMap:w,mixinDataSourceItemRuntimeInfoMap:M,updateDataSourceItemRuntimeInfoForUid:x,updateWidgetDisplayMode:I}),f===g.NoLayersTip&&(0,e.jsx)("div",{className:"no-layers-panel w-100 h-100 d-flex align-items-center"},(0,e.jsx)("div",{className:"no-layers-panel-content w-100 h-100"},(0,e.jsx)(s,{width:24,height:24}),(0,e.jsx)("div",{className:"mt-2 mb-2"},p("noLayersAvailableTip")),(null===(n=window.jimuConfig)||void 0===n?void 0:n.isInBuilder)&&(0,e.jsx)("div",null,p("openSettingPanelTip")))),f===g.Loading&&(0,e.jsx)(t.Loading,{type:"SECONDARY"}),f===g.Placeholder&&(0,e.jsx)(t.WidgetPlaceholder,{widgetId:i,icon:Fe(),message:p("_widgetLabel")}))};We.mapExtraStateProps=(e,t)=>{var a,n;let o=!1,s=0,r="",i="";const l=function(e,t){var a,n,o;if(e&&!e.useMap&&(null===(n=null===(a=e.dataAttributeInfo)||void 0===a?void 0:a.dataSourceItems)||void 0===n?void 0:n.length)>0){const a=null===(o=e.dataAttributeInfo)||void 0===o?void 0:o.dataSourceItems,n=function(e,t){let a=e;if(e&&e.length>0){const n=[];t&&t.length>0&&t.forEach((e=>{const t=null==e?void 0:e.dataSourceId;t&&n.push(t)}));let o=!1;const s=e.filter((e=>{const t=null==e?void 0:e.useDataSource,a=null==t?void 0:t.dataSourceId,s=a&&n.includes(a);return s||(o=!0),s}));a=o?s:e}return a||(a=e),a}(a,t);n&&n!==a&&(e=e.setIn(["dataAttributeInfo","dataSourceItems"],n))}return e}(t.config,t.useDataSources)||t.config;(null===(a=e.appContext)||void 0===a?void 0:a.isRTL)&&(o=!0),e.dataSourcesInfo&&(s=Object.keys(e.dataSourcesInfo).length);const c=t.useMapWidgetIds;return c&&c.length>0&&(r=c[0]),e.mapWidgetsInfo&&r&&(i=(null===(n=e.mapWidgetsInfo[r])||void 0===n?void 0:n.autoControlWidgetId)||""),{isRTL:o,dataSourceCount:s,mapWidgetId:r,autoControlWidgetId:i,config:l}},We.versionManager=Ge;const He=We;function Je(e){i.p=e}})(),l})())}}}));